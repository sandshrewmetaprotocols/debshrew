# Debshrew Architecture

Debshrew is designed with a modular architecture that separates concerns and enables flexibility in deployment and configuration.

## System Components

Debshrew consists of the following main components:

### 1. Main Service (debshrew)

The main service is responsible for:
- Synchronizing with metashrew
- Processing blocks
- Handling reorgs
- Managing the block cache
- Sending CDC messages to configured sinks

### 2. WASM Runtime (debshrew-runtime)

The WASM runtime provides:
- Host functions for transform modules
- WASM module execution
- State management
- View function registration and calling

### 3. Support Library (debshrew-support)

The support library contains:
- Common data structures
- Serialization utilities
- Error handling
- CDC message definitions

### 4. Transform Modules

Transform modules are WASM modules that:
- Implement the `DebTransform` trait
- Query metashrew views
- Detect changes
- Generate CDC messages
- Handle rollbacks

### 5. CDC Sinks

CDC sinks are responsible for:
- Receiving CDC messages
- Delivering them to external systems
- Handling retries and failures
- Batching and flushing

## Data Flow

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  Metashrew  │────▶│  Debshrew   │────▶│  CDC Sink   │
└─────────────┘     └─────────────┘     └─────────────┘
                          │
                          ▼
                    ┌─────────────┐
                    │   WASM      │
                    │  Transform  │
                    └─────────────┘
```

1. Debshrew polls metashrew for new blocks
2. When a new block is found, it's passed to the WASM transform module
3. The transform module queries metashrew views and generates CDC messages
4. CDC messages are sent to the configured sink
5. The sink delivers the messages to external systems

## Block Synchronization

The block synchronizer is the heart of Debshrew. It:

1. Polls metashrew for the latest block height
2. Compares it with the current height
3. If new blocks are available, processes them sequentially
4. If a reorg is detected, rolls back to the common ancestor and reprocesses blocks

## Reorg Handling

Debshrew handles blockchain reorganizations by:

1. Maintaining a cache of recent blocks and state snapshots
2. Detecting reorgs by comparing block hashes
3. Finding the common ancestor between the old and new chain
4. Rolling back the state to the common ancestor
5. Generating inverse CDC messages for rolled back blocks
6. Processing the new chain from the common ancestor

## State Management

Transform modules maintain state that:

1. Is persisted between block processing
2. Can be rolled back during reorgs
3. Is managed by the WASM runtime
4. Is accessible through host functions

## CDC Message Generation

CDC messages are generated by transform modules and:

1. Follow the Debezium format
2. Include block and transaction metadata
3. Represent create, update, and delete operations
4. Include before and after states for records
5. Are deterministic for the same input

## Sink Management

Debshrew supports multiple sink types:

1. **Kafka**: Sends CDC messages to Kafka topics
2. **PostgreSQL**: Applies CDC messages to PostgreSQL databases
3. **File**: Writes CDC messages to files
4. **Console**: Outputs CDC messages to the console
5. **Custom**: Implement the `CdcSink` trait for custom sinks